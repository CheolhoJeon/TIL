---
description: 집약 함수, GROUP BY 구문, 윈도 함수, OVER(... PARTITION BY ~) 구문
---

# 그룹의 특징 잡기

* SQL은 집약 함수라고 부르는 여러 가지 함수를 제공함
  * 여러 레코드를 기반으로 하나의 값을 리턴하는 함수
  * 레코드의 수, 합계, 평균, 최대, 최소를 계산
* SQL:2003에서 도입된 `윈도 함수`(분석 함수라고도 불림)를 사용하면, 기존의 SQL로는 하기 힘들었던 순서를 고려하는 처리, 여러 개의 레코드를 대상으로 하는 처리를 쉽게 할 수 있음

> 상품 평가 테이블

| user\_id | product\_id | score |
| -------- | ----------- | ----- |
| U001     | A001        | 4     |
| U001     | A002        | 5     |
| U001     | A003        | 5     |
| U002     | A001        | 3     |
| U002     | A002        | 3     |
| U002     | A003        | 4     |
| U003     | A001        | 5     |
| U003     | A002        | 4     |
| U003     | A003        | 4     |

## 1. 테이블 전체의 특징량 계산하기

* `COUNT 함수`는 지정한 컬럼의 레코드 수를 리턴하는 함수
* 컬럼 이름 앞에 `DISTINCT` 구문을 지정하면, 중복을 제외하고 수를 세어줌
* `SUM`, `AVG` 함수는 컬럼의 자료형이 정수 또는 실수 등의 숫자 자료형이어야함
* `MAX`, `MIN` 함수는 각각 최댓값과 최솟값을 구하는 함수
  * 따라서 대소 비교가 가능한 자료형(숫자, 문자열, 타임스탬프 등)에 적용할 수 있음

```sql
SELECT COUNT(*)                   AS total_count,
       COUNT(DISTINCT user_id)    AS user_count,
       COUNT(DISTINCT product_id) AS product_count,
       SUM(score)                 AS sum,
       AVG(score)                 AS avg,
       MAX(score)                 AS max,
       MIN(score)                 AS min
FROM review;
```

| total\_count | user\_count | product\_count | sum | avg               | max | min |
| ------------ | ----------- | -------------- | --- | ----------------- | --- | --- |
| 9            | 3           | 3              | 37  | 4.111111111111111 | 5   | 3   |

## 2. 그루핑한 데이터의 특징량 계산하기

* 데이터를 조금 더 작게 분할하고 싶다면 `GROUP BY 구문`을 사용해 데이터를 분류할 키를 지정하고, 그러한 키를 기반으로 데이터를 집약할 수 있음
* 이때 GROUP BY 구문을 사용한 쿼리에서는, GROUP BY 구문에 지정한 컬럼 또는 집약 함수만 SELECT 구문의 컬럼으로 지정할 수 있음

{% hint style="info" %}
GROUP BY 구문을 사용한 쿼리에서는 GROUP BY 구문에 지정한 컬럼을 유니크 키로 새로운 테이블을 만들게 됨 이 과정에서 GROUP BY 구문에 지정하지 않은 컬럼은 사라져버림 따라서 집약 함수를 적용한 값과 집약 전의 값은 동시에 사용할 수 없는 것임
{% endhint %}

```sql
SELECT user_id,
       COUNT(*)                   AS total_count,
       COUNT(DISTINCT product_id) AS product_count,
       SUM(score)                 AS sum,
       AVG(score)                 AS avg,
       MAX(score)                 AS max,
       MIN(score)                 AS min
FROM review
GROUP BY user_id;
```

| user\_id | total\_count | product\_count | sum | avg                | max | min |
| -------- | ------------ | -------------- | --- | ------------------ | --- | --- |
| U001     | 3            | 3              | 14  | 4.666666666666667  | 5   | 4   |
| U002     | 3            | 3              | 10  | 3.3333333333333335 | 4   | 3   |
| U003     | 3            | 3              | 13  | 4.333333333333333  | 5   | 4   |

## 3. 집약 함수를 적용한 값과 집약 전의 값을 동시에 다루기

* SQL:2003 이후에 정의된 윈도 함수가 지원되는 환경이라면, 윈도 함수를 사용해서 쉽고 효율적으로 집약 함수의 결과와 원래 값을 조합합 수 있음
* 집약 함수로 윈도 함수를 사용하려면, 집약 함수 뒤에 `OVER 구문`을 붙이고 여기에 윈도 함수를 지정함
* `OVER 구문`에 매개 변수를 지정하지 않으면 테이블 전체에 집약 함수를 적용한 값이 리턴됨
* 매개 변수에 `PARTITION BY <컬럼이름>`을 지정하면 해당 컬럼 값을 기반으로 그룹화하고 집약 함수를 적용함

```sql
SELECT user_id,
       product_id,
       -- 개별 리뷰 점수
       score,
       -- 전체 평균 리뷰 점수
       AVG(score) OVER ()                             AS avg_score,
       -- 사용자의 평균 리뷰 점수
       AVG(score) OVER (PARTITION BY user_id)         AS user_avg_score,
       -- 개별 리뷰 점수와 사용자 평균 리뷰 점수의 차이
       score - AVG(score) OVER (PARTITION BY user_id) AS user_avg_score_diff
FROM review;
```

| user\_id | product\_id | score | avg\_score        | user\_avg\_score   | user\_avg\_score\_diff |
| -------- | ----------- | ----- | ----------------- | ------------------ | ---------------------- |
| U001     | A001        | 4     | 4.111111111111111 | 4.666666666666667  | -0.6666666666666667    |
| U001     | A002        | 5     | 4.111111111111111 | 4.666666666666667  | 0.3333333333333333     |
| U001     | A003        | 5     | 4.111111111111111 | 4.666666666666667  | 0.3333333333333333     |
| U002     | A001        | 3     | 4.111111111111111 | 3.3333333333333335 | -0.3333333333333333    |
| U002     | A002        | 3     | 4.111111111111111 | 3.3333333333333335 | -0.3333333333333333    |
| U002     | A003        | 4     | 4.111111111111111 | 3.3333333333333335 | 0.6666666666666667     |
| U003     | A001        | 5     | 4.111111111111111 | 4.333333333333333  | 0.6666666666666667     |
| U003     | A002        | 4     | 4.111111111111111 | 4.333333333333333  | -0.3333333333333333    |
| U003     | A003        | 4     | 4.111111111111111 | 4.333333333333333  | -0.3333333333333333    |
